<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>GS칼텍스 인천물류센터 출입자 시스템</title>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Nanum+Gothic:wght@400;700&display=swap" rel="stylesheet">
  <style>
    :root{--c-bg:#ffffff;--c-accent:#3EDB86;--c-ink:#0A1E2E}
    *{box-sizing:border-box} html,body{height:100%}
    body{margin:0;font-family:"Nanum Gothic",system-ui,Arial,sans-serif;background:var(--c-bg);color:var(--c-ink)}
    .wrap{max-width:600px;margin:0 auto;padding:16px}
    header{display:flex;align-items:center;gap:8px;justify-content:space-between;margin-bottom:8px}
    .brand{font-weight:700;line-height:1.2}
    .progress{font-size:12px;opacity:.8}
    .btn{border:0;border-radius:12px;padding:12px 14px;background:var(--c-accent);color:#0A1E2E;cursor:pointer;font-weight:700}
    .btn:disabled{opacity:.45;cursor:not-allowed}
    .btn-outline{background:#fff;border:1px solid #e7e7e7;color:var(--c-ink)}
    .back{padding:8px 10px;border-radius:10px;border:1px solid #e7e7e7;background:#fff}
    .card{border:1px solid #e7e7e7;border-radius:14px;padding:14px;margin:12px 0;background:#fff}
    .grid{display:grid;gap:10px}
    .choice{display:flex;align-items:center;justify-content:center;padding:14px;border:1px solid #e7e7e7;border-radius:12px;background:#fff;min-height:54px;cursor:pointer;font-weight:700;text-align:center}
    .list{display:grid;gap:8px}
    .checkline{display:flex;gap:10px;align-items:flex-start}
    .checkline input{margin-top:5px}
    .footer{position:sticky;bottom:0;background:linear-gradient(#ffffffcc,#ffffff);padding:12px 0;margin-top:10px}
    .muted{font-size:12px;opacity:.75}
    .pill{display:inline-block;padding:6px 10px;border-radius:999px;background:#eef9f3;border:1px solid #def2e7;font-size:12px}
    .hide{display:none !important}
    :focus-visible{outline:2px solid var(--c-accent);outline-offset:2px}
    .sig-box{border:1px dashed #cbd5e1;border-radius:12px;background:#fff}
    .qrbox{display:flex;align-items:center;justify-content:center;border:1px dashed #cbd5e1;border-radius:12px;min-height:220px;background:#fff}
    textarea{width:100%;padding:8px;border:1px solid #e7e7e7;border-radius:10px}
  </style>
</head>
<body>
  <div class="wrap" role="application" aria-label="GS칼텍스 인천물류센터 출입자 시스템">
    <header>
      <button id="backBtn" class="back" aria-label="이전 단계로 이동" title="뒤로">← 뒤로</button>
      <div>
        <div class="brand">GS칼텍스 인천물류센터<br>출입자 시스템</div>
        <div class="progress" id="progress" aria-live="polite">1 / 7</div>
      </div>
      <span class="pill" id="roleBadge" aria-label="선택된 유형">유형 미선택</span>
    </header>

    <main id="screens" aria-live="polite">
      <!-- 1) 첫 화면: 유형 선택 -->
      <section class="card" data-screen="role" role="region" aria-labelledby="h-role">
        <h1 id="h-role" class="stage-title">GS칼텍스 인천물류센터 출입자 시스템</h1>
        <p class="muted">아래에서 출입 유형을 선택하세요.</p>
        <div class="grid">
          <button type="button" class="choice" data-role="공사 출입자" aria-label="공사 출입자 선택">공사 출입자</button>
          <button type="button" class="choice" data-role="일반 출입자" aria-label="일반 출입자 선택">일반 출입자</button>
          <button type="button" class="choice" data-role="유조차 기사" aria-label="유조차 기사 선택">유조차 기사</button>
        </div>
        <div class="card" style="background:#f8fffb;border-color:#def2e7">
          ※ 본 데모는 <strong>공사 출입자</strong> 흐름만 상세 구현되어 있습니다.
        </div>
      </section>

      <!-- 2) 공사 정보 선택 -->
      <section class="card hide" data-screen="contract" role="region" aria-labelledby="h-contract">
        <h2 id="h-contract" class="stage-title">공사 정보 선택</h2>
        <div class="list" role="list">
          <button type="button" class="choice" role="listitem" data-contract="메트로씨앤씨 | 안전난간 설치공사">(1) 메트로씨앤씨, 안전난간 설치공사</button>
          <button type="button" class="choice" role="listitem" data-contract="해광전설산업 | D127 소방시설 전기 개선공사">(2) 해광전설산업, D127 소방시설 전기 개선공사</button>
          <button type="button" class="choice" role="listitem" data-contract="해광전설산업 | G-139 인버터 판넬 인입 공사">(3) 해광전설산업, G-139 인버터 판넬 인입 공사</button>
        </div>
      </section>

      <!-- 3) 동의서 3종 -->
      <section class="card hide" data-screen="agreements" role="region" aria-labelledby="h-agree">
        <h2 id="h-agree" class="stage-title">개인정보 · 보안 · 안전 다짐</h2>
        <div class="list">
          <label class="checkline"><input type="checkbox" data-bind="agree1"> <span><strong>개인정보수집·활용 동의서</strong> (출입관리 목적)</span></label>
          <label class="checkline"><input type="checkbox" data-bind="agree2"> <span><strong>보안서약서</strong> (업무상 정보 무단 반출 금지)</span></label>
          <label class="checkline"><input type="checkbox" data-bind="agree3"> <span><strong>안전공사다짐서</strong> (안전수칙 준수/위험 즉시 보고)</span></label>
        </div>
        <div class="footer">
          <div class="muted">모두 체크 시 다음 단계로 이동 가능</div>
          <div style="display:flex;justify-content:flex-end;margin-top:8px">
            <button type="button" class="btn" id="toEdu" disabled>다음</button>
          </div>
        </div>
      </section>

      <!-- 4) 교육 및 숙지사항 -->
      <section class="card hide" data-screen="education" role="region" aria-labelledby="h-edu">
        <h2 id="h-edu" class="stage-title">교육 및 숙지사항</h2>
        <div class="list">
          <label class="checkline"><input type="checkbox" data-edu="1"> ① 설비 임의조작 금지</label>
          <label class="checkline"><input type="checkbox" data-edu="2"> ② 지정된 장소(공사지정구역)에서만 작업</label>
          <label class="checkline"><input type="checkbox" data-edu="3"> ③ 승인된 시간에만 작업 수행</label>
          <label class="checkline"><input type="checkbox" data-edu="4"> ④ 이동 시 안전관리자/현장소장 지휘 하 이동</label>
          <label class="checkline"><input type="checkbox" data-edu="5"> ⑤ 위험성평가 미실시 작업 발견 시 즉시 중단·평가 후 재개</label>
          <label class="checkline"><input type="checkbox" data-edu="6"> ⑥ 비상대응 절차 숙지(대피로/집결지 등)</label>
        </div>
        <div class="footer" style="display:flex;justify-content:space-between;align-items:center">
          <span class="muted">6개 모두 체크 시 다음 단계 활성화</span>
          <button type="button" class="btn" id="toHealth" disabled>다음</button>
        </div>
      </section>

      <!-- 4.5) 건강 문진표 -->
      <section class="card hide" data-screen="health" role="region" aria-labelledby="h-health">
        <h2 id="h-health" class="stage-title">건강 문진표</h2>
        <p class="muted">해당되는 항목을 체크하고, 문진 내용 확인에 동의해주세요.</p>
        <div class="list">
          <label class="checkline"><input type="checkbox" data-health="hypertension"> 고혈압</label>
          <label class="checkline"><input type="checkbox" data-health="diabetes"> 당뇨</label>
          <label class="checkline"><input type="checkbox" data-health="medication"> 복용 중인 약이 있음</label>
          <label class="checkline"><input type="checkbox" data-health="alcohol"> 최근 음주</label>
          <label class="checkline"><input type="checkbox" data-health="cardioResp"> 심혈관/호흡기 질환</label>
          <label class="checkline" aria-label="기타 메모 입력">
            <span style="width:100%">
              기타(선택)
              <textarea id="healthMemo" rows="3" placeholder="기타 증상 또는 전달사항(선택)" style="margin-top:6px"></textarea>
            </span>
          </label>
          <hr style="border:none;border-top:1px solid #eee;margin:6px 0">
          <label class="checkline">
            <input type="checkbox" id="healthConfirm"> <span><strong>문진 내용 확인</strong>에 동의합니다. (필수)</span>
          </label>
        </div>
        <div class="footer" style="display:flex;justify-content:space-between;align-items:center">
          <span class="muted">“문진 내용 확인” 체크 시 다음 단계 활성화</span>
          <button type="button" class="btn" id="toSign" disabled>다음</button>
        </div>
      </section>

      <!-- 5) 서명 -->
      <section class="card hide" data-screen="sign" role="region" aria-labelledby="h-sign">
        <h2 id="h-sign" class="stage-title">서명</h2>
        <div class="sig-box">
          <canvas id="sigPad" width="320" height="180" aria-label="서명 영역" role="img" tabindex="0"></canvas>
        </div>
        <div style="display:flex;gap:8px;margin-top:8px">
          <button type="button" class="btn-outline" id="clearSig">지우기</button>
          <button type="button" class="btn" id="toQR" disabled>서명 완료</button>
        </div>
      </section>

      <!-- 6) 안내(일반/유조차) -->
      <section class="card hide" data-screen="placeholder" role="region" aria-labelledby="h-ph">
        <h2 id="h-ph" class="stage-title">준비 중</h2>
        <p class="muted">데모에서는 공사 출입자 플로우를 먼저 확인해주세요.</p>
      </section>

      <!-- 7) QR 표시 -->
<!-- 7) QR 표시 -->
<section class="card hide" data-screen="qr" role="region" aria-labelledby="h-qr">
  <h2 id="h-qr" class="stage-title">QR 코드</h2>
  <p class="muted">문자열 <strong>TEST1103</strong> 표시용 데모 QR입니다.</p>
  <div class="qrbox">
    <canvas id="qrCanvas" width="260" height="260" aria-label="데모 QR(시각 표시)"></canvas>
  </div>

  <!-- [추가된 안내 문구] -->
  <div
    style="margin-top:12px;padding:12px;border-left:4px solid var(--c-accent);
           background:#f8fffb;border-radius:10px;font-weight:700;font-size:18px;line-height:1.35">
    혈압측정을 진행 후에 종이를 경비실에 가져다주세요
  </div>
</section>
      </section>
    </main>
  </div>

  <script>
    // ===== 안전장치: 런타임 오류가 있으면 화면 상단에 배너로 표시 =====
    window.addEventListener('error', (e)=>{
      const b=document.createElement('div');
      b.style.cssText='position:fixed;top:0;left:0;right:0;background:#ffe8e8;color:#7a0000;padding:8px 12px;font-size:12px;z-index:9999';
      b.textContent = '스크립트 오류: ' + (e.message||'');
      document.body.appendChild(b);
    });

    // ===== 상태 & 네비게이션 =====
    const screens = [...document.querySelectorAll('[data-screen]')];
    const progressEl = document.getElementById('progress');
    const roleBadge = document.getElementById('roleBadge');
    const backBtn = document.getElementById('backBtn');

    const FLOW = ['role','contract','agreements','education','health','sign','qr'];
    const state = {
      step: 0,
      role: null,
      contract: null,
      agree: {agree1:false,agree2:false,agree3:false},
      edu: {1:false,2:false,3:false,4:false,5:false,6:false},
      health: {hypertension:false,diabetes:false,medication:false,alcohol:false,cardioResp:false,memo:'',confirm:false},
      signed:false
    };

    function show(screenName){
      // 화면 전환
      screens.forEach(s => s.classList.toggle('hide', s.dataset.screen !== screenName));
      const idx = Math.max(0, FLOW.indexOf(screenName));
      state.step = idx;
      progressEl.textContent = `${idx+1} / ${FLOW.length}`;
      backBtn.disabled = (idx===0);
      backBtn.setAttribute('aria-disabled', String(idx===0));
      // 포커스 이동(접근성)
      const section = screens.find(s=>s.dataset.screen===screenName);
      if(section){ section.setAttribute('tabindex','-1'); section.focus({preventScroll:false}); }
    }

    function setRole(r){ state.role = r; roleBadge.textContent = r || '유형 미선택'; }

    // 초기 화면
    show('role');

    // 뒤로가기
    backBtn.addEventListener('click', ()=>{
      if(state.step<=0) return;
      show(FLOW[state.step-1]);
    });

    // 1) 유형 선택 → 다음 화면
    document.querySelectorAll('[data-screen="role"] .choice').forEach(btn=>{
      btn.addEventListener('click', (ev)=>{
        ev.preventDefault(); // 일부 브라우저에서 버튼 기본 동작 방지
        const r = btn.dataset.role;
        setRole(r);
        if(r === '공사 출입자'){ show('contract'); }
        else { show('placeholder'); }
      }, {passive:false});
    });

    // 2) 공사 선택
    document.querySelectorAll('[data-screen="contract"] .choice').forEach(btn=>{
      btn.addEventListener('click', (ev)=>{
        ev.preventDefault();
        state.contract = btn.dataset.contract;
        show('agreements');
      }, {passive:false});
    });

    // 3) 동의서 체크
    const agreeInputs = document.querySelectorAll('[data-screen="agreements"] input[type="checkbox"]');
    const toEduBtn = document.getElementById('toEdu');
    agreeInputs.forEach(chk=>{
      chk.addEventListener('change', ()=>{
        state.agree[chk.dataset.bind] = chk.checked;
        toEduBtn.disabled = !(state.agree.agree1 && state.agree.agree2 && state.agree.agree3);
      });
    });
    toEduBtn.addEventListener('click', ()=> show('education'));

    // 4) 숙지사항 체크 → 건강 문진으로
    const eduChecks = document.querySelectorAll('[data-screen="education"] [data-edu]');
    const toHealthBtn = document.getElementById('toHealth');
    function updateEduReady(){
      let ok=true; for(const k of [1,2,3,4,5,6]) ok = ok && !!state.edu[k];
      toHealthBtn.disabled = !ok;
    }
    eduChecks.forEach(chk=>{
      chk.addEventListener('change', ()=>{
        state.edu[chk.dataset.edu] = chk.checked;
        updateEduReady();
      });
    });
    toHealthBtn.addEventListener('click', ()=> show('health'));

    // 4.5) 건강 문진 → 서명
    const healthChecks = document.querySelectorAll('[data-screen="health"] input[type="checkbox"][data-health]');
    const healthMemoEl = document.getElementById('healthMemo');
    const healthConfirmEl = document.getElementById('healthConfirm');
    const toSignBtn = document.getElementById('toSign');
    function updateHealth(){
      healthChecks.forEach(chk=> state.health[chk.dataset.health]=chk.checked);
      state.health.memo = healthMemoEl.value.trim();
      state.health.confirm = healthConfirmEl.checked;
      toSignBtn.disabled = !state.health.confirm;
    }
    healthChecks.forEach(chk=> chk.addEventListener('change', updateHealth));
    healthMemoEl.addEventListener('input', updateHealth);
    healthConfirmEl.addEventListener('change', updateHealth);
    toSignBtn.addEventListener('click', ()=> show('sign'));

    // 5) 서명 패드
    const sig = document.getElementById('sigPad');
    const ctx = sig.getContext('2d');
    let drawing=false, last=null, hasStroke=false;
    function resizeSig(){
      const ratio = Math.max(window.devicePixelRatio||1,1);
      const w = sig.clientWidth || 320, h = 180;
      sig.width = Math.floor(w*ratio); sig.height = Math.floor(h*ratio);
      ctx.setTransform(ratio,0,0,ratio,0,0);
      ctx.fillStyle='#fff'; ctx.fillRect(0,0,w,h);
      ctx.lineWidth=2; ctx.lineCap='round'; ctx.strokeStyle='#000';
    }
    sig.style.width='100%'; sig.style.height='180px'; resizeSig(); window.addEventListener('resize', resizeSig);
    function getPos(e){const r=sig.getBoundingClientRect();const t=e.touches&&e.touches[0];const c=t||e;return {x:c.clientX-r.left,y:c.clientY-r.top};}
    function start(e){drawing=true; last=getPos(e); e.preventDefault();}
    function move(e){if(!drawing) return; const p=getPos(e); ctx.beginPath(); ctx.moveTo(last.x,last.y); ctx.lineTo(p.x,p.y); ctx.stroke(); last=p; hasStroke=true; e.preventDefault(); enableSign();}
    function end(){drawing=false;}
    sig.addEventListener('mousedown',start); sig.addEventListener('mousemove',move); sig.addEventListener('mouseup',end); sig.addEventListener('mouseleave',end);
    sig.addEventListener('touchstart',start,{passive:false}); sig.addEventListener('touchmove',move,{passive:false}); sig.addEventListener('touchend',end);
    const clearSig=document.getElementById('clearSig'); const toQRBtn=document.getElementById('toQR');
    function enableSign(){ toQRBtn.disabled = !hasStroke; }
    clearSig.addEventListener('click', ()=>{ const w=sig.clientWidth,h=180; ctx.clearRect(0,0,w,h); ctx.fillStyle='#fff'; ctx.fillRect(0,0,w,h); hasStroke=false; enableSign(); });
    toQRBtn.addEventListener('click', ()=>{ if(hasStroke){ state.signed=true; show('qr'); drawDemoQR('TEST1103'); } });

// [교체] 데모용 가짜 QR → 실제 QR을 캔버스에 렌더
function drawDemoQR(text){
  const c = document.getElementById('qrCanvas');
  if(!c){ console.warn('qrCanvas not found'); return; }
  const size = Math.min(c.width || 220, c.height || 220);

  // 임시 컨테이너에 실제 QR 생성 (오프스크린)
  const holder = document.createElement('div');
  const q = new QRCode(holder, { width: size, height: size }); // qrcode.js 필요
  q.makeCode(text);

  const g = c.getContext('2d');
  g.imageSmoothingEnabled = false;
  g.fillStyle = '#fff';
  g.fillRect(0, 0, size, size);

  // qrcode.js는 브라우저에 따라 <canvas> 또는 <img>를 만들 수 있음
  const srcCanvas = holder.querySelector('canvas');
  const srcImg = holder.querySelector('img');

  if (srcCanvas) {
    // 캔버스가 바로 만들어진 경우
    g.drawImage(srcCanvas, 0, 0, size, size);
  } else if (srcImg) {
    // 이미지가 만들어진 경우 (onload 고려)
    if (srcImg.complete) {
      g.drawImage(srcImg, 0, 0, size, size);
    } else {
      srcImg.onload = () => g.drawImage(srcImg, 0, 0, size, size);
      srcImg.onerror = () => alert('QR 이미지를 불러오지 못했습니다.');
    }
  } else {
    alert('QR 생성에 실패했습니다.');
  }

  // 하단 라벨(선택)
  g.fillStyle = '#0A1E2E';
  g.fillRect(0, size - 22, size, 22);
  g.fillStyle = '#fff';
  g.font = '12px "Nanum Gothic", Arial';
  g.fillText('DATA: ' + text, 8, size - 7);
}

// [추가] 페이지 진입 시 요구 텍스트로 즉시 생성
document.addEventListener('DOMContentLoaded', () => {
  drawDemoQR('TEST1103');
});

  </script>
</body>
</html>
