<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>GS칼텍스 인천물류센터 출입자 시스템</title>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Nanum+Gothic:wght@400;700&display=swap" rel="stylesheet">
  <style>
    :root{--c-bg:#ffffff;--c-accent:#3EDB86;--c-ink:#0A1E2E}
    *{box-sizing:border-box} html,body{height:100%}
    body{margin:0;font-family:"Nanum Gothic",system-ui,Arial,sans-serif;background:var(--c-bg);color:var(--c-ink)}
    .wrap{max-width:600px;margin:0 auto;padding:16px}
    header{display:flex;align-items:center;gap:8px;justify-content:space-between;margin-bottom:8px}
    .brand{font-weight:700;line-height:1.2}
    .progress{font-size:12px;opacity:.8}
    .btn{border:0;border-radius:12px;padding:12px 14px;background:var(--c-accent);color:#0A1E2E;cursor:pointer;font-weight:700}
    .btn:disabled{opacity:.45;cursor:not-allowed}
    .btn-outline{background:#fff;border:1px solid #e7e7e7;color:var(--c-ink)}
    .back{padding:8px 10px;border-radius:10px;border:1px solid #e7e7e7;background:#fff}
    .card{border:1px solid #e7e7e7;border-radius:14px;padding:14px;margin:12px 0;background:#fff}
    .grid{display:grid;gap:10px}
    .choice{display:flex;align-items:center;justify-content:center;padding:14px;border:1px solid #e7e7e7;border-radius:12px;background:#fff;min-height:54px;cursor:pointer;font-weight:700;text-align:center}
    .list{display:grid;gap:8px}
    .checkline{display:flex;gap:10px;align-items:flex-start}
    .checkline input{margin-top:5px}
    .footer{position:sticky;bottom:0;background:linear-gradient(#ffffffcc,#ffffff);padding:12px 0;margin-top:10px}
    .muted{font-size:12px;opacity:.75}
    .pill{display:inline-block;padding:6px 10px;border-radius:999px;background:#eef9f3;border:1px solid #def2e7;font-size:12px}
    .hide{display:none !important}
    :focus-visible{outline:2px solid var(--c-accent);outline-offset:2px}
    .sig-box{border:1px dashed #cbd5e1;border-radius:12px;background:#fff}
    .qrbox{display:flex;align-items:center;justify-content:center;border:1px dashed #cbd5e1;border-radius:12px;min-height:220px;background:#fff}
    textarea{width:100%;padding:8px;border:1px solid #e7e7e7;border-radius:10px}
  </style>
</head>
<body>
  <div class="wrap" role="application" aria-label="GS칼텍스 인천물류센터 출입자 시스템">
    <header>
      <button id="backBtn" class="back" aria-label="이전 단계로 이동" title="뒤로">← 뒤로</button>
      <div>
        <div class="brand">GS칼텍스 인천물류센터<br>출입자 시스템</div>
        <div class="progress" id="progress" aria-live="polite">1 / 7</div>
      </div>
      <span class="pill" id="roleBadge" aria-label="선택된 유형">유형 미선택</span>
    </header>

    <main id="screens" aria-live="polite">
      <!-- 1) 첫 화면: 유형 선택 -->
      <section class="card" data-screen="role" role="region" aria-labelledby="h-role">
        <h1 id="h-role" class="stage-title">GS칼텍스 인천물류센터 출입자 시스템</h1>
        <p class="muted">아래에서 출입 유형을 선택하세요.</p>
        <div class="grid">
          <button type="button" class="choice" data-role="공사 출입자" aria-label="공사 출입자 선택">공사 출입자</button>
          <button type="button" class="choice" data-role="일반 출입자" aria-label="일반 출입자 선택">일반 출입자</button>
          <button type="button" class="choice" data-role="유조차 기사" aria-label="유조차 기사 선택">유조차 기사</button>
        </div>
        <div class="card" style="background:#f8fffb;border-color:#def2e7">
          ※ 본 데모는 <strong>공사 출입자</strong> 흐름만 상세 구현되어 있습니다.
        </div>
      </section>

      <!-- 2) 공사 정보 선택 -->
      <section class="card hide" data-screen="contract" role="region" aria-labelledby="h-contract">
        <h2 id="h-contract" class="stage-title">공사 정보 선택</h2>
        <div class="list" role="list">
          <button type="button" class="choice" role="listitem" data-contract="메트로씨앤씨 | 안전난간 설치공사">(1) 메트로씨앤씨, 안전난간 설치공사</button>
          <button type="button" class="choice" role="listitem" data-contract="해광전설산업 | D127 소방시설 전기 개선공사">(2) 해광전설산업, D127 소방시설 전기 개선공사</button>
          <button type="button" class="choice" role="listitem" data-contract="해광전설산업 | G-139 인버터 판넬 인입 공사">(3) 해광전설산업, G-139 인버터 판넬 인입 공사</button>
        </div>
      </section>

      <!-- 3) 동의서 3종 -->
      <section class="card hide" data-screen="agreements" role="region" aria-labelledby="h-agree">
        <h2 id="h-agree" class="stage-title">개인정보 · 보안 · 안전 다짐</h2>
        <div class="list">
          <label class="checkline"><input type="checkbox" data-bind="agree1"> <span><strong>개인정보수집·활용 동의서</strong> (출입관리 목적)</span></label>
          <label class="checkline"><input type="checkbox" data-bind="agree2"> <span><strong>보안서약서</strong> (업무상 정보 무단 반출 금지)</span></label>
          <label class="checkline"><input type="checkbox" data-bind="agree3"> <span><strong>안전공사다짐서</strong> (안전수칙 준수/위험 즉시 보고)</span></label>
        </div>
<!-- [기존] agreements 섹션 푸터 내부 div 교체 -->
<div class="footer">
  <div class="muted">모두 체크 시 다음 단계로 이동 가능</div>
  <div style="display:flex;justify-content:space-between;align-items:center;margin-top:8px;gap:8px">
    <!-- 같은 크기/같은 색상: .btn 사용 -->
    <button type="button" class="btn" id="checkAllAgree" aria-label="동의 항목 모두 선택">모두 동의</button>
    <button type="button" class="btn" id="toEdu" disabled>다음</button>
  </div>
</div>

      </section>

      <!-- 4) 교육 및 숙지사항 -->
      <section class="card hide" data-screen="education" role="region" aria-labelledby="h-edu">
        <h2 id="h-edu" class="stage-title">교육 및 숙지사항</h2>
        <div class="list">
          <label class="checkline"><input type="checkbox" data-edu="1"> ① 설비 임의조작 금지</label>
          <label class="checkline"><input type="checkbox" data-edu="2"> ② 지정된 장소(공사지정구역)에서만 작업</label>
          <label class="checkline"><input type="checkbox" data-edu="3"> ③ 승인된 시간에만 작업 수행</label>
          <label class="checkline"><input type="checkbox" data-edu="4"> ④ 이동 시 안전관리자/현장소장 지휘 하 이동</label>
          <label class="checkline"><input type="checkbox" data-edu="5"> ⑤ 위험성평가 미실시 작업 발견 시 즉시 중단·평가 후 재개</label>
          <label class="checkline"><input type="checkbox" data-edu="6"> ⑥ 비상대응 절차 숙지(대피로/집결지 등)</label>
        </div>
        <div class="footer" style="display:flex;justify-content:space-between;align-items:center">
  <span class="muted">6개 모두 체크 시 다음 단계 활성화</span>
  <div style="display:flex;gap:8px;align-items:center">
    <!-- 동일 스타일 버튼 추가 -->
    <button type="button" class="btn" id="checkAllEdu" aria-label="숙지사항 모두 체크">모두 동의</button>
    <button type="button" class="btn" id="toHealth" disabled>다음</button>
  </div>
</div>

      </section>

      <!-- 4.5) 건강 문진표 -->
      <section class="card hide" data-screen="health" role="region" aria-labelledby="h-health">
        <h2 id="h-health" class="stage-title">건강 문진표</h2>
        <p class="muted">해당되는 항목을 체크하고, 문진 내용 확인에 동의해주세요.</p>
        <div class="list">
          <label class="checkline"><input type="checkbox" data-health="hypertension"> 고혈압</label>
          <label class="checkline"><input type="checkbox" data-health="diabetes"> 당뇨</label>
          <label class="checkline"><input type="checkbox" data-health="medication"> 복용 중인 약이 있음</label>
          <label class="checkline"><input type="checkbox" data-health="alcohol"> 최근 음주</label>
          <label class="checkline"><input type="checkbox" data-health="cardioResp"> 심혈관/호흡기 질환</label>
          <label class="checkline" aria-label="기타 메모 입력">
            <span style="width:100%">
              기타(선택)
              <textarea id="healthMemo" rows="3" placeholder="기타 증상 또는 전달사항(선택)" style="margin-top:6px"></textarea>
            </span>
          </label>
          <hr style="border:none;border-top:1px solid #eee;margin:6px 0">
          <label class="checkline">
            <input type="checkbox" id="healthConfirm"> <span><strong>문진 내용 확인</strong>에 동의합니다. (필수)</span>
          </label>
        </div>
        <div class="footer" style="display:flex;justify-content:space-between;align-items:center">
          <span class="muted">“문진 내용 확인” 체크 시 다음 단계 활성화</span>
          <button type="button" class="btn" id="toSign" disabled>다음</button>
        </div>
      </section>

      <!-- 5) 서명 -->
      <section class="card hide" data-screen="sign" role="region" aria-labelledby="h-sign">
        <h2 id="h-sign" class="stage-title">서명</h2>
        <div class="sig-box">
          <canvas id="sigPad" width="320" height="180" aria-label="서명 영역" role="img" tabindex="0"></canvas>
        </div>
        <div style="display:flex;gap:8px;margin-top:8px">
          <button type="button" class="btn-outline" id="clearSig">지우기</button>
          <button type="button" class="btn" id="toQR" disabled>서명 완료</button>
        </div>
      </section>

      <!-- 6) 안내(일반/유조차) -->
      <section class="card hide" data-screen="placeholder" role="region" aria-labelledby="h-ph">
        <h2 id="h-ph" class="stage-title">준비 중</h2>
        <p class="muted">데모에서는 공사 출입자 플로우를 먼저 확인해주세요.</p>
      </section>

      <!-- 7) QR 표시 -->
      <section class="card hide" data-screen="qr" role="region" aria-labelledby="h-qr">
        <h2 id="h-qr" class="stage-title">QR 코드</h2>
        <p class="muted">문자열 <strong>TEST1103</strong> 표시용 데모 QR입니다.</p>
        <div class="qrbox">
          <canvas id="qrCanvas" width="260" height="260" aria-label="실제 스캔 가능한 QR"></canvas>
        </div>
        <div
          style="margin-top:12px;padding:12px;border-left:4px solid var(--c-accent);
                 background:#f8fffb;border-radius:10px;font-weight:700;font-size:18px;line-height:1.35">
          혈압측정을 진행 후에 종이를 경비실에 가져다주세요
        </div>
      </section>
    </main>
  </div>

  <script>
    // ===== 안전장치: 런타임 오류 배너 =====
    window.addEventListener('error', (e)=>{
      const b=document.createElement('div');
      b.style.cssText='position:fixed;top:0;left:0;right:0;background:#ffe8e8;color:#7a0000;padding:8px 12px;font-size:12px;z-index:9999';
      b.textContent = '스크립트 오류: ' + (e.message||'');
      document.body.appendChild(b);
    });

    // ===== 상태 & 네비게이션 =====
    const screens = [...document.querySelectorAll('[data-screen]')];
    const progressEl = document.getElementById('progress');
    const roleBadge = document.getElementById('roleBadge');
    const backBtn = document.getElementById('backBtn');

    const FLOW = ['role','contract','agreements','education','health','sign','qr'];
    const state = {
      step: 0,
      role: null,
      contract: null,
      agree: {agree1:false,agree2:false,agree3:false},
      edu: {1:false,2:false,3:false,4:false,5:false,6:false},
      health: {hypertension:false,diabetes:false,medication:false,alcohol:false,cardioResp:false,memo:'',confirm:false},
      signed:false
    };

    function show(screenName){
      screens.forEach(s => s.classList.toggle('hide', s.dataset.screen !== screenName));
      const idx = Math.max(0, FLOW.indexOf(screenName));
      state.step = idx;
      progressEl.textContent = `${idx+1} / ${FLOW.length}`;
      backBtn.disabled = (idx===0);
      backBtn.setAttribute('aria-disabled', String(idx===0));
      const section = screens.find(s=>s.dataset.screen===screenName);
      if(section){ section.setAttribute('tabindex','-1'); section.focus({preventScroll:false}); }
    }
    function setRole(r){ state.role = r; roleBadge.textContent = r || '유형 미선택'; }
    show('role');

    backBtn.addEventListener('click', ()=>{
      if(state.step<=0) return;
      show(FLOW[state.step-1]);
    });

    // 1) 유형 선택
    document.querySelectorAll('[data-screen="role"] .choice').forEach(btn=>{
      btn.addEventListener('click', (ev)=>{
        ev.preventDefault();
        const r = btn.dataset.role;
        setRole(r);
        if(r === '공사 출입자'){ show('contract'); }
        else { show('placeholder'); }
      }, {passive:false});
    });

    // 2) 공사 선택
    document.querySelectorAll('[data-screen="contract"] .choice').forEach(btn=>{
      btn.addEventListener('click', (ev)=>{
        ev.preventDefault();
        state.contract = btn.dataset.contract;
        show('agreements');
      }, {passive:false});
    });

    // 3) 동의서
    const agreeInputs = document.querySelectorAll('[data-screen="agreements"] input[type="checkbox"]');
    const toEduBtn = document.getElementById('toEdu');
    agreeInputs.forEach(chk=>{
      chk.addEventListener('change', ()=>{
        state.agree[chk.dataset.bind] = chk.checked;
        toEduBtn.disabled = !(state.agree.agree1 && state.agree.agree2 && state.agree.agree3);
      });
    });
    toEduBtn.addEventListener('click', ()=> show('education'));

// [동의서] 모두 동의 버튼
const checkAllAgree = document.getElementById('checkAllAgree');
checkAllAgree.addEventListener('click', ()=>{
  agreeInputs.forEach(chk=>{
    chk.checked = true;
    state.agree[chk.dataset.bind] = true;
    chk.dispatchEvent(new Event('change', { bubbles:true }));
  });
  toEduBtn.disabled = false;
});


// 모두 동의 버튼 핸들러
checkAllAgree.addEventListener('click', ()=>{
  agreeInputs.forEach(chk => {
    chk.checked = true;
    // 상태 동기화
    state.agree[chk.dataset.bind] = true;
    // 화면의 다른 로직과 일관되게 change 이벤트도 발생시킴
    chk.dispatchEvent(new Event('change', { bubbles: true }));
  });
  // 모두 체크되었으므로 다음 버튼 활성화 보장
  toEduBtn.disabled = false;
});

    
    // 4) 숙지사항
    const eduChecks = document.querySelectorAll('[data-screen="education"] [data-edu]');
    const toHealthBtn = document.getElementById('toHealth');
    function updateEduReady(){
      let ok=true; for(const k of [1,2,3,4,5,6]) ok = ok && !!state.edu[k];
      toHealthBtn.disabled = !ok;
    }
    eduChecks.forEach(chk=>{
      chk.addEventListener('change', ()=>{
        state.edu[chk.dataset.edu] = chk.checked;
        updateEduReady();
      });
    });
    toHealthBtn.addEventListener('click', ()=> show('health'));

    // [교육] 모두 동의 버튼
const checkAllEdu = document.getElementById('checkAllEdu');
checkAllEdu.addEventListener('click', ()=>{
  eduChecks.forEach(chk=>{
    chk.checked = true;
    state.edu[chk.dataset.edu] = true;
    chk.dispatchEvent(new Event('change', { bubbles:true }));
  });
  updateEduReady(); // toHealthBtn 활성화 반영
});


    // 4.5) 건강 문진
    const healthChecks = document.querySelectorAll('[data-screen="health"] input[type="checkbox"][data-health]');
    const healthMemoEl = document.getElementById('healthMemo');
    const healthConfirmEl = document.getElementById('healthConfirm');
    const toSignBtn = document.getElementById('toSign');
    function updateHealth(){
      healthChecks.forEach(chk=> state.health[chk.dataset.health]=chk.checked);
      state.health.memo = healthMemoEl.value.trim();
      state.health.confirm = healthConfirmEl.checked;
      toSignBtn.disabled = !state.health.confirm;
    }
    healthChecks.forEach(chk=> chk.addEventListener('change', updateHealth));
    healthMemoEl.addEventListener('input', updateHealth);
    healthConfirmEl.addEventListener('change', updateHealth);
    toSignBtn.addEventListener('click', ()=> show('sign'));

    // 5) 서명 패드
    const sig = document.getElementById('sigPad');
    const ctx = sig.getContext('2d');
    let drawing=false, last=null, hasStroke=false;
    function resizeSig(){
      const ratio = Math.max(window.devicePixelRatio||1,1);
      const w = sig.clientWidth || 320, h = 180;
      sig.width = Math.floor(w*ratio); sig.height = Math.floor(h*ratio);
      ctx.setTransform(ratio,0,0,ratio,0,0);
      ctx.fillStyle='#fff'; ctx.fillRect(0,0,w,h);
      ctx.lineWidth=2; ctx.lineCap='round'; ctx.strokeStyle='#000';
    }
    sig.style.width='100%'; sig.style.height='180px'; resizeSig(); window.addEventListener('resize', resizeSig);
    function getPos(e){const r=sig.getBoundingClientRect();const t=e.touches&&e.touches[0];const c=t||e;return {x:c.clientX-r.left,y:c.clientY-r.top};}
    function start(e){drawing=true; last=getPos(e); e.preventDefault();}
    function move(e){if(!drawing) return; const p=getPos(e); ctx.beginPath(); ctx.moveTo(last.x,last.y); ctx.lineTo(p.x,p.y); ctx.stroke(); last=p; hasStroke=true; e.preventDefault(); enableSign();}
    function end(){drawing=false;}
    sig.addEventListener('mousedown',start); sig.addEventListener('mousemove',move); sig.addEventListener('mouseup',end); sig.addEventListener('mouseleave',end);
    sig.addEventListener('touchstart',start,{passive:false}); sig.addEventListener('touchmove',move,{passive:false}); sig.addEventListener('touchend',end);
    const clearSig=document.getElementById('clearSig'); const toQRBtn=document.getElementById('toQR');
    function enableSign(){ toQRBtn.disabled = !hasStroke; }
    clearSig.addEventListener('click', ()=>{ const w=sig.clientWidth,h=180; ctx.clearRect(0,0,w,h); ctx.fillStyle='#fff'; ctx.fillRect(0,0,w,h); hasStroke=false; enableSign(); });
    toQRBtn.addEventListener('click', ()=>{ if(hasStroke){ state.signed=true; show('qr'); drawDemoQR('TEST1103'); } });

    // ===== qrcode.js (MIT, Kazuhiko Arase / davidshimjs) - 최소 캔버스 렌더 포함 =====
    /*! qrcode.js v1.0.0 | MIT | (c) Kazuhiko Arase / davidshimjs */
    (function(window){function QR8bitByte(d){this.mode=4;this.data=d}
    QR8bitByte.prototype={getLength:function(){return this.data.length},write:function(b){for(var i=0;i<this.data.length;i++)b.put(this.data.charCodeAt(i),8)}};
    var ECL={L:1,M:0,Q:3,H:2},EXP=new Array(256),LOG=new Array(256);for(var i=0;i<8;i++)EXP[i]=1<<i;for(i=8;i<256;i++)EXP[i]=EXP[i-4]^EXP[i-5]^EXP[i-6]^EXP[i-8];for(i=0;i<256;i++)LOG[EXP[i]]=i;
    function gexp(n){for(;n<0;)n+=255;for(;n>=256;)n-=255;return EXP[n]}function glog(n){if(n<1)throw new Error("glog("+n+")");return LOG[n]}
    function QRPolynomial(num,shift){var o=0;while(o<num.length&&num[o]==0)o++;this.num=new Array(num.length-o+shift);for(var i=0;i<num.length-o;i++)this.num[i]=num[i+o]}
    QRPolynomial.prototype={get:function(i){return this.num[i]},getLength:function(){return this.num.length},multiply:function(e){var n=new Array(this.getLength()+e.getLength()-1);for(var i=0;i<this.getLength();i++)for(var j=0;j<e.getLength();j++)n[i+j]^=gexp(glog(this.get(i))+glog(e.get(j)));return new QRPolynomial(n,0)},mod:function(e){if(this.getLength()-e.getLength()<0)return this;var ratio=glog(this.get(0))-glog(e.get(0)),num=this.num.slice();for(var i=0;i<e.getLength();i++)num[i]^=gexp(glog(e.get(i))+ratio);return new QRPolynomial(num,0).mod(e)}};
    var RS_TABLE=[[],[1,26,19],[1,44,34],[1,70,55],[1,100,80],[1,134,108],[2,86,68],[2,98,78],[2,121,97],[2,146,116],[2,86,68,2,87,69],[2,98,78,2,99,79],[2,121,97,2,122,98],[2,146,116,2,147,117],[2,86,68,4,87,69],[2,98,78,4,99,79],[2,121,97,4,122,98],[2,146,116,4,147,117],[2,86,68,4,87,69],[2,98,78,4,99,79],[4,121,97]];
    function getRSBlocks(t){var r=RS_TABLE[t];var list=[];for(var i=0;i<r.length/3;i++){for(var c=0;c<r[3*i];c++)list.push({totalCount:r[3*i+1],dataCount:r[3*i+2]});}return list}
    var Util={PATTERN_POS:function(){return[[],[6,18],[6,22],[6,26],[6,30],[6,34],[6,22,38],[6,24,42],[6,26,46],[6,28,50],[6,30,54],[6,32,58],[6,34,62]]},
      BCHD:function(d){var n=0;while(d!=0){n++;d>>=1}return n},
      BCHTypeInfo:function(d){for(var v=d<<10;Util.BCHD(v)-Util.BCHD(1335)>=0;)v^=1335<<Util.BCHD(v)-Util.BCHD(1335);return (d<<10|v)^21522},
      BCHTypeNumber:function(d){for(var v=d<<12;Util.BCHD(v)-Util.BCHD(7973)>=0;)v^=7973<<Util.BCHD(v)-Util.BCHD(7973);return d<<12|v},
      getMask:function(p,i,j){switch(p){case 0:return(i+j)%2==0;case 1:return i%2==0;case 2:return j%3==0;case 3:return(i+j)%3==0;case 4:return(Math.floor(i/2)+Math.floor(j/3))%2==0;case 5:return i*j%2+i*j%3==0;case 6:return (i*j%2+i*j%3)%2==0;case 7:return (i*j%3+(i+j)%2)%2==0;default:throw'bad mask'}} ,
      getLengthInBits:function(mode,type){if(type<10){return mode==4?8:8}else if(type<27){return mode==4?16:16}else{return mode==4?16:16}},
      getErrorCorrectPolynomial:function(len){var a=new QRPolynomial([1],0);for(var i=0;i<len;i++)a=a.multiply(new QRPolynomial([1,gexp(i)],0));return a},
      lostPoint:function(qr){var m=qr.getModuleCount(),lost=0;for(var r=0;r<m;r++)for(var c=0;c<m;c++){var same=0,d=qr.isDark(r,c);for(var dr=-1;dr<=1;dr++)if(!(r+dr<0||m<=r+dr))for(var dc=-1;dc<=1;dc++)if(!(c+dc<0||m<=c+dc))if(!(dr==0&&dc==0))d==qr.isDark(r+dr,c+dc)&&(same++);same>5&&(lost+=3+same-5)}return lost}};
    function BitBuffer(){this.buffer=[];this.length=0}
    BitBuffer.prototype={put:function(num,len){for(var i=0;i<len;i++)this.putBit(((num>>>(len-i-1))&1)==1)},getLengthInBits:function(){return this.length},putBit:function(bit){var i=Math.floor(this.length/8);this.buffer.length<=i&&this.buffer.push(0);bit&&(this.buffer[i]|=0x80>>(this.length%8));this.length++}};
    function QRCodeModel(typeNumber,ecLevel){this.typeNumber=typeNumber;this.errorCorrectLevel=ecLevel;this.modules=null;this.moduleCount=0;this.dataList=[];this.dataCache=null}
    QRCodeModel.prototype={addData:function(d){this.dataList.push(new QR8bitByte(d));this.dataCache=null},
      isDark:function(r,c){if(this.modules[r][c]!=null)return this.modules[r][c];throw r+","+c},
      getModuleCount:function(){return this.moduleCount},
      make:function(){if(this.typeNumber<1){for(var t=1;t<40;t++){var rs=getRSBlocks(t,ECL.M),buf=new BitBuffer();for(var i=0;i<this.dataList.length;i++)buf.put(4,4),buf.put(this.dataList[i].getLength(),Util.getLengthInBits(4,t)),this.dataList[i].write(buf);for(buf.put(0,4);buf.getLengthInBits()%8!=0;)buf.put(0,1);for(;buf.getLengthInBits()<8*(function(rs){var s=0;for(var i=0;i<rs.length;i++)s+=rs[i].dataCount;return s})(rs);)buf.put(236,8),buf.put(17,8);this.typeNumber=t;break}}this.makeImpl(false,this.getBestMaskPattern())},
      makeImpl:function(test,mask){this.moduleCount=4*this.typeNumber+17;this.modules=new Array(this.moduleCount);for(var r=0;r<this.moduleCount;r++){this.modules[r]=new Array(this.moduleCount);for(var c=0;c<this.moduleCount;c++)this.modules[r][c]=null}
        this.setupPositionProbePattern(0,0);this.setupPositionProbePattern(this.moduleCount-7,0);this.setupPositionProbePattern(0,this.moduleCount-7);this.setupTimingPattern();this.setupTypeInfo(test,mask);this.typeNumber>=7&&this.setupTypeNumber(test);
        if(this.dataCache==null){var rs=getRSBlocks(this.typeNumber,ECL.M),buf=new BitBuffer();for(var i=0;i<this.dataList.length;i++)buf.put(4,4),buf.put(this.dataList[i].getLength(),Util.getLengthInBits(4,this.typeNumber)),this.dataList[i].write(buf);for(buf.put(0,4);buf.getLengthInBits()%8!=0;)buf.put(0,1);for(;buf.getLengthInBits()<8*(function(rs){var s=0;for(var i=0;i<rs.length;i++)s+=rs[i].dataCount;return s})(rs);)buf.put(236,8),buf.put(17,8);this.dataCache=(function(qr,buffer,rs){var off=0,maxDC=0,maxEC=0,dc=[],ec=[];for(var r=0;r<rs.length;r++){var dcCount=rs[r].dataCount,ecCount=rs[r].totalCount-dcCount;maxDC=Math.max(maxDC,dcCount);maxEC=Math.max(maxEC,ecCount);dc[r]=new Array(dcCount);for(var i=0;i<dcCount;i++)dc[r][i]=buffer.buffer[i+off];off+=dcCount;var rsPoly=new QRPolynomial([1],0);for(i=0;i<ecCount;i++)rsPoly=rsPoly.multiply(new QRPolynomial([1,gexp(i)],0));var raw=new QRPolynomial(dc[r],0);var mod=raw.mod(rsPoly);ec[r]=new Array(rsPoly.getLength());for(i=0;i<ec[r].length;i++)ec[r][i]=mod.get(i)}var total=0;for(i=0;i<rs.length;i++)total+=rs[i].totalCount;var data=new Array(total),idx=0;for(i=0;i<maxDC;i++)for(r=0;r<rs.length;r++)i<dc[r].length&&(data[idx++]=dc[r][i]);for(i=0;i<maxEC;i++)for(r=0;r<rs.length;r++)i<ec[r].length&&(data[idx++]=ec[r][i]);return data})(0,buf,rs)}
        this.mapData(this.dataCache,mask)},
      setupPositionProbePattern:function(r,c){for(var i=-1;i<=7;i++)if(!(r+i<=-1||this.moduleCount<=r+i))for(var j=-1;j<=7;j++)if(!(c+j<=-1||this.moduleCount<=c+j))this.modules[r+i][c+j]=i>=0&&i<=6&&(j==0||j==6)||j>=0&&j<=6&&(i==0||i==6)||i>=2&&i<=4&&j>=2&&j<=4},
      setupTimingPattern:function(){for(var r=8;r<this.moduleCount-8;r++){this.modules[r][6]==null&&(this.modules[r][6]=r%2==0);this.modules[6][r]==null&&(this.modules[6][r]=r%2==0)}},
      setupTypeNumber:function(test){var bits=Util.BCHTypeNumber(this.typeNumber);for(var i=0;i<18;i++){var mod=!test&&((bits>>i)&1)==1;this.modules[Math.floor(i/3)][i%3+this.moduleCount-11]=mod;this.modules[i%3+this.moduleCount-11][Math.floor(i/3)]=mod}},
      setupTypeInfo:function(test,mask){var data=ECL.M<<3|mask,bits=Util.BCHTypeInfo(data);for(var i=0;i<15;i++){var mod=!test&&((bits>>i)&1)==1;i<6?this.modules[i][8]=mod:i<8?this.modules[i+1][8]=mod:this.modules[this.moduleCount-15+i][8]=mod}
        for(i=0;i<15;i++){mod=!test&&((bits>>i)&1)==1;i<8?this.modules[8][this.moduleCount-i-1]=mod:i<9?this.modules[8][15-i]=mod:this.modules[8][15-i-1]=mod}
        this.modules[this.moduleCount-8][8]=!test},
      mapData:function(data,mask){var inc=-1,row=this.moduleCount-1,bit=7,byte=0;for(var col=this.moduleCount-1;col>0;col-=2){col==6&&col--;for(;;){for(var c=0;c<2;c++)this.modules[row][col-c]==null&&(this.modules[row][col-c]=byte<data.length?((data[byte]>>>bit)&1)==1:false,bit--,bit==-1&&(byte++,bit=7));row+=inc;if(row<0||this.moduleCount<=row){row-=inc;inc=-inc;break}}}},
      getBestMaskPattern:function(){var min=0,pat=0;for(var i=0;i<8;i++){this.makeImpl(true,i);var lost=(function(q){return Util.lostPoint(q)})(this);(i==0||lost<min)&&(min=lost,pat=i)}return pat},
      makeImage:function(size){var cnt=this.moduleCount,cs=size/cnt,canvas=document.createElement('canvas');canvas.width=canvas.height=size;var g=canvas.getContext('2d');g.fillStyle="#fff";g.fillRect(0,0,size,size);g.fillStyle="#000";for(var r=0;r<cnt;r++)for(var c=0;c<cnt;c++)this.isDark(r,c)&&g.fillRect(Math.round(c*cs),Math.round(r*cs),Math.ceil(cs),Math.ceil(cs));return canvas}};
    function QRCode(el,opt){this._el=el;this._opt=opt||{}}
    QRCode.prototype.makeCode=function(text){var qr=new QRCodeModel(0,ECL.M);qr.addData(text);qr.make();this._el.innerHTML="";var img=qr.makeImage(this._opt.width||200);img.setAttribute('alt',text);this._el.appendChild(img)};
    window.QRCode=QRCode;})(window);

    // ===== 실제 QR을 캔버스에 렌더 =====
 function drawDemoQR(text){
  const c = document.getElementById('qrCanvas');
  if(!c){ console.warn('qrCanvas not found'); return; }
  const size = Math.min(c.width || 220, c.height || 220);

  // 오프스크린에 실제 QR 생성
  const holder = document.createElement('div');
  const q = new QRCode(holder, { width: size, height: size }); // qrcode.js 사용
  q.makeCode(text);

  const g = c.getContext('2d');
  g.imageSmoothingEnabled = false;

  // 전체 바탕 흰색
  g.fillStyle = '#fff';
  g.fillRect(0, 0, size, size);

  // 90% 크기로 축소 렌더(Quiet Zone 확보 → 인식률 향상)
  const scale = 0.90;                 // ← 요구사항: 90%
  const inner = Math.round(size * scale);
  const pad = Math.floor((size - inner) / 2);

  const drawSrc = (imgOrCanvas)=>{
    g.drawImage(imgOrCanvas, pad, pad, inner, inner);
  };

  // qrcode.js 산출물 추출(<canvas> 또는 <img>)
  const srcCanvas = holder.querySelector('canvas');
  const srcImg = holder.querySelector('img');

  if (srcCanvas) {
    drawSrc(srcCanvas);
  } else if (srcImg) {
    if (srcImg.complete) drawSrc(srcImg);
    else {
      srcImg.onload = () => drawSrc(srcImg);
      srcImg.onerror = () => alert('QR 이미지를 불러오지 못했습니다.');
    }
  } else {
    alert('QR 생성에 실패했습니다.');
  }

  // ⚠ 하단 라벨(사각형/텍스트)은 제거된 상태(가림 현상 방지)
}


    // 초기 렌더: TEST1103
    document.addEventListener('DOMContentLoaded', () => {
      drawDemoQR('TEST1103');
    });
  </script>
</body>
</html>
